<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Scanner Stok Barang</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    /* Mobile First CSS */
    * {
      box-sizing: border-box;
    }
    
    body { 
      font-family: Arial, sans-serif; 
      padding: 15px; 
      background: #f8f8f8; 
      margin: 0;
      font-size: 16px;
    }
    
    h2 {
      font-size: 1.4rem;
      margin: 10px 0;
      color: #333;
    }
    
    h3 {
      font-size: 1.2rem;
      margin: 8px 0;
    }
    
    label { 
      font-weight: bold; 
      margin-top: 12px; 
      display: block;
      font-size: 15px;
    }
    
    input, select, textarea { 
      width: 100%; 
      padding: 12px; 
      margin: 5px 0 15px 0; 
      border: 1px solid #ddd; 
      border-radius: 6px; 
      font-size: 16px; /* Mencegah zoom di iOS */
      background: white;
    }
    
    button { 
      width: 100%; 
      padding: 14px; 
      margin: 8px 0; 
      border: none; 
      border-radius: 6px; 
      font-size: 16px; 
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    button:active {
      transform: scale(0.98);
    }
    
    .lokasi-buttons { 
      display: flex; 
      gap: 10px; 
      margin: 10px 0; 
    }
    
    .lokasi-buttons button {
      flex: 1;
      padding: 12px;
    }
    
    .button-group { 
      display: flex; 
      flex-direction: column;
      gap: 10px; 
      margin-top: 20px; 
    }
    
    .button-group button { 
      margin: 0;
    }
    
    #reader { 
      width: 100%; 
      max-width: 100%; 
      margin: 15px 0; 
      display: none;
      border-radius: 8px;
      overflow: hidden;
      position: relative;
      min-height: 300px;
      background: #000;
    }
    
    /* Styling untuk area scan */
    #reader__scan_region {
      width: 100% !important;
    }
    
    #reader__dashboard {
      padding: 10px;
      background: rgba(0,0,0,0.8);
      color: white;
    }
    
    #html5-qrcode-anchor-scan-type-change {
      color: #4CAF50 !important;
      font-weight: bold;
    }
    
    .camera-controls {
      display: flex;
      gap: 10px;
      margin: 10px 0;
    }
    
    .camera-controls button {
      flex: 1;
      padding: 10px;
      font-size: 14px;
    }
    
    table { 
      width: 100%; 
      border-collapse: collapse; 
      margin: 15px 0; 
      font-size: 14px;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    th, td { 
      padding: 12px 8px; 
      text-align: left; 
      border-bottom: 1px solid #eee; 
    }
    
    th { 
      background-color: #4CAF50; 
      color: white; 
      font-weight: bold;
      position: sticky;
      top: 0;
    }
    
    tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    
    tr:hover {
      background-color: #f5f5f5;
    }
    
    .tab-container { 
      display: flex; 
      margin: 15px 0; 
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .tab { 
      flex: 1; 
      padding: 15px; 
      text-align: center; 
      background: #ddd; 
      cursor: pointer; 
      font-weight: bold;
      font-size: 15px;
      border: none;
    }
    
    .tab.active { 
      background: #4CAF50; 
      color: white; 
    }
    
    .tab-content { 
      display: none; 
      padding: 15px 0;
    }
    
    .tab-content.active { 
      display: block; 
    }
    
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.7);
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    
    .modal-content {
      background-color: white;
      margin: 20px auto;
      padding: 25px;
      width: 95%;
      max-width: 100%;
      border-radius: 12px;
      position: relative;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }
    
    .modal-content.long {
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .modal-buttons {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 20px;
    }
    
    .user-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 12px;
      margin: 15px 0;
    }
    
    .user-button {
      padding: 15px 10px;
      background: #e0e0e0;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      text-align: center;
      word-break: break-word;
    }
    
    .user-button.active {
      background: #4CAF50;
      color: white;
      box-shadow: 0 3px 6px rgba(76, 175, 80, 0.3);
    }
    
    .camera-status {
      margin: 15px 0;
      padding: 12px;
      border-radius: 8px;
      text-align: center;
      font-weight: bold;
    }
    
    .camera-status.active {
      background: #d4edda;
      color: #155724;
      border: 2px solid #155724;
    }
    
    .camera-status.inactive {
      background: #f8d7da;
      color: #721c24;
      border: 2px solid #721c24;
    }
    
    .progress-bar-container {
      width: 100%;
      background-color: #f0f0f0;
      border-radius: 10px;
      margin: 20px 0;
      display: none;
      overflow: hidden;
    }
    
    .progress-bar {
      width: 0%;
      height: 30px;
      background: linear-gradient(90deg, #4CAF50, #45a049);
      border-radius: 10px;
      text-align: center;
      color: white;
      line-height: 30px;
      font-weight: bold;
      font-size: 16px;
      transition: width 0.3s ease;
    }
    
    #supabaseStatus {
      margin: 15px 0;
      padding: 12px;
      border-radius: 8px;
      display: none;
      font-size: 15px;
      font-weight: bold;
      text-align: center;
    }
    
    hr {
      border: none;
      height: 2px;
      background: #eee;
      margin: 20px 0;
    }
    
    /* Responsive Table */
    @media (max-width: 768px) {
      table {
        font-size: 13px;
      }
      
      th, td {
        padding: 10px 6px;
      }
      
      .button-group button {
        padding: 12px;
        font-size: 15px;
      }
      
      .modal-content {
        width: 98%;
        margin: 10px auto;
        padding: 20px;
      }
      
      .user-list {
        grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
      }
    }
    
    /* Untuk layar sangat kecil */
    @media (max-width: 480px) {
      body {
        padding: 10px;
      }
      
      h2 {
        font-size: 1.2rem;
      }
      
      button {
        padding: 12px;
        font-size: 15px;
      }
      
      .tab {
        padding: 12px;
        font-size: 14px;
      }
      
      .user-list {
        grid-template-columns: 1fr;
      }
      
      .user-button {
        padding: 15px;
      }
    }
    
    /* Scrollbar styling untuk mobile */
    ::-webkit-scrollbar {
      width: 6px;
    }
    
    ::-webkit-scrollbar-track {
      background: #f1f1f1;
    }
    
    ::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 3px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: #555;
    }
    
    /* Loading spinner */
    .loading-spinner {
      display: none;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #4CAF50;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Item checkbox styling */
    .item-checkbox {
      width: 22px;
      height: 22px;
      margin: 0;
    }
    
    /* Status colors */
    .status-success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .status-error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .status-warning {
      background-color: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }
    
    /* File upload button */
    input[type="file"] {
      padding: 10px;
      background: white;
    }
    
    /* Logo */
    img[alt="Logo Perusahaan"] {
      max-width: 120px;
      height: auto;
      display: block;
      margin: 0 auto 15px auto;
    }
    
    /* Location items table dalam modal */
    #locationItemsTable {
      font-size: 14px;
    }
    
    #locationItemsTable th,
    #locationItemsTable td {
      padding: 10px;
      vertical-align: middle;
    }
    
    #locationItemsTable input[type="number"] {
      width: 70px;
      padding: 8px;
      font-size: 14px;
    }
    
    /* Mobile action buttons */
    .action-buttons {
      display: flex;
      gap: 5px;
    }
    
    .action-buttons button {
      padding: 6px 10px;
      font-size: 13px;
      flex: 1;
    }
    
    /* Hide scrollbar on mobile when not needed */
    .hide-scrollbar {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
    
    .hide-scrollbar::-webkit-scrollbar {
      display: none;
    }
    
    /* Camera overlay */
    .camera-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1;
    }
    
    .scan-region {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 70%;
      height: 200px;
      border: 3px solid #4CAF50;
      border-radius: 10px;
      box-shadow: 0 0 0 1000px rgba(0, 0, 0, 0.5);
    }
    
    .scan-line {
      position: absolute;
      top: 20%;
      left: 10%;
      width: 80%;
      height: 4px;
      background: #4CAF50;
      animation: scan 2s linear infinite;
      border-radius: 2px;
    }
    
    @keyframes scan {
      0% { top: 20%; }
      50% { top: 80%; }
      100% { top: 20%; }
    }
    
    /* Camera selector */
    .camera-selector {
      margin: 10px 0;
      display: none;
    }
    
    .camera-selector select {
      width: 100%;
      padding: 10px;
      border-radius: 6px;
      border: 2px solid #4CAF50;
      background: white;
      font-size: 14px;
    }
    
    /* Scanner instructions */
    .scanner-instructions {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      margin: 10px 0;
      border-left: 4px solid #4CAF50;
      font-size: 14px;
    }
    
    .scanner-instructions ul {
      margin: 10px 0;
      padding-left: 20px;
    }
    
    .scanner-instructions li {
      margin-bottom: 8px;
    }
    
    /* Success feedback */
    .scan-success {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(76, 175, 80, 0.9);
      color: white;
      padding: 20px;
      border-radius: 10px;
      z-index: 10000;
      font-weight: bold;
      font-size: 18px;
      display: none;
      animation: fadeInOut 2s ease-in-out;
    }
    
    @keyframes fadeInOut {
      0% { opacity: 0; }
      10% { opacity: 1; }
      90% { opacity: 1; }
      100% { opacity: 0; }
    }
    
    /* Flash effect */
    .flash {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: white;
      opacity: 0;
      pointer-events: none;
      z-index: 9999;
      animation: flashEffect 0.5s;
    }
    
    @keyframes flashEffect {
      0% { opacity: 0; }
      50% { opacity: 0.8; }
      100% { opacity: 0; }
    }
    
    /* Scanner buttons container */
    .scanner-buttons {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    
    .scanner-buttons button {
      flex: 1;
      padding: 12px;
    }
  </style>
</head>
<body>
  <img src="https://raw.githubusercontent.com/achmadnawawi44-sudo/Scanner-barang-SO/main/goto.png" alt="Logo Perusahaan">
  <h2>Scanner Stok Opname Goto Living</h2>
  
  <!-- Status Koneksi Supabase -->
  <div id="supabaseStatus"></div>
  
  <!-- Flash effect untuk scan sukses -->
  <div class="flash" id="flashEffect"></div>
  
  <!-- Feedback scan sukses -->
  <div class="scan-success" id="scanSuccess">
    <div style="text-align: center;">
      <div style="font-size: 40px; margin-bottom: 10px;">‚úÖ</div>
      <div>Barcode berhasil discan!</div>
    </div>
  </div>
  
  <!-- Modal Supabase Settings -->
  <div id="supabaseModal" class="modal">
    <div class="modal-content">
      <h3>‚öôÔ∏è Konfigurasi Supabase</h3>
      <p>Masukkan kredensial Supabase Anda:</p>
      <label>URL Supabase:</label>
      <input type="text" id="supabaseUrl" placeholder="https://your-project.supabase.co" />
      <label>API Key:</label>
      <input type="password" id="supabaseKey" placeholder="Your API Key" />
      <div class="modal-buttons">
        <button id="saveSupabaseConfigBtn" style="background-color: #4CAF50; color: white;">Simpan Konfigurasi</button>
        <button id="cancelSupabaseConfigBtn" style="background-color: #f44336; color: white;">Batal</button>
      </div>
    </div>
  </div>

  <!-- Modal Pilih Lokasi -->
  <div id="locationModal" class="modal">
    <div class="modal-content long">
      <h3>üìç Ambil Data per Lokasi</h3>
      <p><strong>Pilih lokasi untuk mengambil data dan mengisi qty:</strong></p>
      
      <div style="margin: 15px 0;">
        <label>Cari Lokasi:</label>
        <input type="text" id="filterLocation" placeholder="üîç Ketik nama lokasi..." style="width: 100%; padding: 12px; font-size: 16px;" />
      </div>
      
      <div id="progressBarContainer" class="progress-bar-container">
        <div class="progress-bar" id="progressBar">0%</div>
      </div>
      
      <div id="loadingStatus" style="margin: 15px 0; padding: 15px; text-align: center; display: none; background: #f8f9fa; border-radius: 8px;">
        <div style="font-size: 16px; font-weight: bold; margin-bottom: 10px;">üîÑ Memuat data...</div>
        <div id="loadingDetails" style="font-size: 14px; color: #666;"></div>
      </div>
      
      <div id="locationList" class="user-list">
        <!-- Lokasi akan dimuat di sini -->
      </div>
      
      <div id="locationDataInfo" style="margin: 20px 0; padding: 15px; background: #e8f5e8; border-radius: 8px; display: none; border-left: 5px solid #4CAF50;">
        <div id="selectedLocationInfo" style="font-size: 16px; font-weight: bold; color: #155724;"></div>
        <div id="locationItemCount" style="font-size: 14px; color: #388e3c; margin-top: 5px;"></div>
      </div>
      
      <div class="modal-buttons">
        <button id="loadLocationDataBtn" style="background-color: #4CAF50; color: white; display: none; padding: 16px; font-size: 16px; font-weight: bold;">
          üì• MUAT DATA LOKASI INI
        </button>
        <button id="closeLocationModalBtn" style="background-color: #6c757d; color: white; padding: 16px; font-size: 16px;">Tutup</button>
      </div>
    </div>
  </div>

  <!-- Modal Isi Qty per Item -->
  <div id="qtyModal" class="modal">
    <div class="modal-content long">
      <h3>üìù Isi Qty untuk <span id="modalLocationName" style="color: #4CAF50;"></span></h3>
      
      <div style="margin-bottom: 20px; padding: 15px; background: #f0f7ff; border-radius: 8px;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div id="currentLocationInfo" style="font-size: 16px; font-weight: bold;"></div>
          <button id="selectAllBtn" style="background-color: #2196F3; color: white; padding: 12px 16px; font-size: 15px; border-radius: 6px;">
            üìã Pilih Semua
          </button>
        </div>
      </div>
      
      <div style="max-height: 60vh; overflow-y: auto; border: 2px solid #e0e0e0; border-radius: 10px; padding: 10px; background: white;">
        <table id="locationItemsTable" style="width: 100%; border-collapse: separate; border-spacing: 0;">
          <thead>
            <tr style="background-color: #4CAF50; color: white;">
              <th style="padding: 15px 10px; border-bottom: 2px solid #388e3c; width: 60px; text-align: center;">
                <input type="checkbox" id="selectAllCheckbox" style="width: 20px; height: 20px;" />
              </th>
              <th style="padding: 15px 10px; border-bottom: 2px solid #388e3c; font-size: 15px;">Nama Barang</th>
              <th style="padding: 15px 10px; border-bottom: 2px solid #388e3c; font-size: 15px;">Barcode</th>
              <th style="padding: 15px 10px; border-bottom: 2px solid #388e3c; width: 100px; font-size: 15px;">Qty</th>
            </tr>
          </thead>
          <tbody id="locationItemsBody">
            <!-- Data akan dimuat di sini -->
          </tbody>
        </table>
      </div>
      
      <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
        <div id="selectedCount" style="font-size: 16px; color: #333; margin-bottom: 15px; text-align: center; font-weight: bold;"></div>
        <div class="modal-buttons">
          <button id="saveQtyBtn" style="background-color: #4CAF50; color: white; padding: 16px; font-size: 16px; font-weight: bold;">
            üíæ SIMPAN KE DATA SCAN
          </button>
          <button id="closeQtyModalBtn" style="background-color: #6c757d; color: white; padding: 16px; font-size: 16px;">Batal</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Tab Container -->
  <div class="tab-container">
    <div class="tab active" data-tab="scanTab">üì± Mode Scan</div>
    <div class="tab" data-tab="uploadTab">üì§ Mode Upload</div>
  </div>

  <!-- Scan Tab -->
  <div id="scanTab" class="tab-content active">
    <label>üë§ User:</label>
    <input type="text" id="userInput" placeholder="Nama user" value="User 1" />
    
    <label>üìç Nama Lokasi:</label>
    <input type="text" id="lokasiInput" placeholder="Contoh: Area A" />
    <div class="lokasi-buttons">
      <button id="lockLokasiBtn" style="background-color: #4CAF50; color: white;">üîí Kunci Lokasi</button>
      <button id="ubahLokasiBtn" style="background-color: #2196F3; color: white;">üîì Ubah Lokasi</button>
    </div>

    <hr>

    <label>üìÇ Upload File Data Barang (CSV/XLSX):</label>
    <input type="file" id="uploadFile" accept=".csv, .xlsx" />
    <button id="uploadFileBtn" style="background-color: #ff9800; color: white;">üì§ Upload File</button>

    <hr>

    <label>üì∑ Scan Barcode:</label>
    <input type="text" id="barcodeInput" placeholder="Scan barcode di sini..." autofocus />
    
    <!-- Scanner Instructions -->
    <div class="scanner-instructions">
      <strong>üìã Cara menggunakan scanner:</strong>
      <ul>
        <li>Klik tombol "üì∑ Aktifkan Kamera Scanner"</li>
        <li>Arahkan kamera ke barcode</li>
        <li>Pastikan barcode berada dalam area kotak hijau</li>
        <li>Scanner akan otomatis membaca barcode</li>
        <li>Klik "‚èπÔ∏è Matikan Kamera" untuk menonaktifkan</li>
      </ul>
    </div>
    
    <!-- Camera Selector -->
    <div class="camera-selector" id="cameraSelector">
      <label>Pilih Kamera:</label>
      <select id="cameraSelect">
        <option value="">Mencari kamera...</option>
      </select>
    </div>
    
    <!-- Camera Controls -->
    <div class="scanner-buttons">
      <button id="scannerButton" style="background-color: #9C27B0; color: white; flex: 2;">üì∑ Aktifkan Kamera Scanner</button>
      <button id="stopScannerButton" style="background-color: #f44336; color: white; display: none; flex: 1;">‚èπÔ∏è Matikan</button>
    </div>
    
    <div id="cameraStatus" class="camera-status inactive">üìµ Kamera tidak aktif</div>
    
    <!-- Camera Container -->
    <div id="reader"></div>
    
    <!-- Manual Input -->
    <div style="margin-top: 20px; padding: 15px; background: #f0f7ff; border-radius: 8px;">
      <label style="color: #2196F3;">üìù Atau masukkan manual:</label>
      <input type="text" id="manualBarcodeInput" placeholder="Masukkan barcode manual..." style="margin-top: 5px;" />
      <button id="manualAddBtn" style="background-color: #2196F3; color: white; margin-top: 10px;">‚ûï Tambah Manual</button>
    </div>
    
    <hr>

    <label>üì¶ Nama Barang:</label>
    <input type="text" id="namaBarangInput" disabled style="background-color: #f5f5f5;" />
    <label>üî¢ Quantity (Qty):</label>
    <input type="number" id="qtyInput" placeholder="Masukkan jumlah..." min="1" value="1" />
    <button id="tambahDataBtn" style="background-color: #4CAF50; color: white; font-size: 17px; padding: 16px;">‚ûï TAMBAH DATA</button>

    <hr>

    <h3>üìä Data Stok Barang:</h3>
    <div style="overflow-x: auto;">
      <table id="dataTable">
        <thead>
          <tr>
            <th>User</th>
            <th>Lokasi</th>
            <th>Barcode</th>
            <th>Nama</th>
            <th>Qty</th>
            <th>Aksi</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Upload Data Tab -->
  <div id="uploadTab" class="tab-content">
    <label>üë§ User:</label>
    <input type="text" id="uploadUserInput" placeholder="Nama user" value="User 1" />
    
    <label>üìç Nama Lokasi:</label>
    <input type="text" id="uploadLokasiInput" placeholder="Contoh: Area A" />
    <div class="lokasi-buttons">
      <button id="lockUploadLokasiBtn" style="background-color: #4CAF50; color: white;">üîí Kunci Lokasi</button>
      <button id="ubahUploadLokasiBtn" style="background-color: #2196F3; color: white;">üîì Ubah Lokasi</button>
    </div>

    <hr>

    <label>üìÇ Upload File Data Barang (CSV/XLSX):</label>
    <input type="file" id="bulkUploadFile" accept=".csv, .xlsx" />
    <button id="bulkUploadBtn" style="background-color: #ff9800; color: white;">üì§ Upload Data Sekaligus</button>

    <hr>

    <h3>üìã Data yang Diupload:</h3>
    <div style="overflow-x: auto;">
      <table id="uploadedItemsTable">
        <thead>
          <tr>
            <th>Barcode</th>
            <th>Nama</th>
            <th>Qty</th>
            <th>Aksi</th>
          </tr>
        </thead>
        <tbody id="uploadedItemsBody"></tbody>
      </table>
    </div>

    <div class="button-group" style="margin-top: 20px;">
      <button id="saveUploadedDataBtn" style="background-color: #4CAF50; color: white;">üíæ Simpan ke Data Scan</button>
      <button id="clearUploadedDataBtn" style="background-color: #f44336; color: white;">üóëÔ∏è Hapus Data</button>
    </div>
  </div>

  <!-- Main Buttons -->
  <div class="button-group">
    <button id="exportDataBtn" style="background-color: #2196F3; color: white;">üì• Download Excel</button>
    <button id="showLocationDataBtn" style="background-color: #10b981; color: white;">üìç Ambil Data per Lokasi</button>
    <button id="saveToSupabaseBtn" style="background-color: #3b82f6; color: white;">‚òÅÔ∏è Simpan ke Supabase</button>
    <button id="showSupabaseConfigBtn" style="background-color: #6b7280; color: white;">‚öôÔ∏è Supabase Settings</button>
    <button id="hapusSemuaDataBtn" style="background-color: #dc2626; color: white;">üóëÔ∏è Hapus Semua Data</button>
  </div>

  <script>
    // =============== VARIABEL GLOBAL ===============
    let dataBarang = {};
    let dataScan = [];
    let lokasiTerkunci = false;
    let uploadLokasiTerkunci = false;
    let scanner = null;
    let uploadedItems = [];
    let supabaseClient = null;
    let isFetchingData = false;
    let isCameraActive = false;
    let availableCameras = [];
    let selectedCameraId = null;

    // =============== FUNGSI INISIALISASI ===============
    function initApp() {
      console.log('Initializing app...');
      
      // Load data dari localStorage
      try {
        const savedDataScan = localStorage.getItem("dataScan");
        const savedUploadedItems = localStorage.getItem("uploadedItems");
        
        if (savedDataScan) {
          dataScan = JSON.parse(savedDataScan);
        }
        
        if (savedUploadedItems) {
          uploadedItems = JSON.parse(savedUploadedItems);
        }
      } catch (error) {
        console.error("Error loading from localStorage:", error);
      }
      
      updateTable();
      updateUploadedItemsTable();
      
      // Cek konfigurasi Supabase
      const supabaseUrl = localStorage.getItem("supabaseUrl");
      const supabaseKey = localStorage.getItem("supabaseKey");
      
      if (supabaseUrl && supabaseKey) {
        initSupabaseClient(supabaseUrl, supabaseKey);
      }
      
      // Setup event listeners
      setupEventListeners();
      
      // Update status Supabase
      setTimeout(() => {
        updateSupabaseStatus();
      }, 1000);
      
      // Fokus ke input barcode
      setTimeout(() => {
        const barcodeInput = document.getElementById("barcodeInput");
        if (barcodeInput) barcodeInput.focus();
      }, 500);
      
      console.log('App initialized successfully');
      
      // Adjust UI for mobile
      adjustForMobile();
      
      // Request permission untuk kamera (hints browser)
      requestCameraPermission();
    }

    // Fungsi untuk request camera permission (hints)
    function requestCameraPermission() {
      if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        navigator.mediaDevices.getUserMedia({ video: true })
          .then(function(stream) {
            // Permission granted, stop semua track
            stream.getTracks().forEach(track => track.stop());
            console.log("Camera permission already granted");
          })
          .catch(function(err) {
            console.log("Camera permission not yet granted:", err.name);
          });
      }
    }

    // Fungsi untuk adjust UI untuk mobile
    function adjustForMobile() {
      // Perbaiki tinggi modal untuk mobile
      const modals = document.querySelectorAll('.modal-content.long');
      modals.forEach(modal => {
        if (window.innerHeight < 700) {
          modal.style.maxHeight = '85vh';
        }
      });
      
      // Perbaiki font size untuk mobile kecil
      if (window.innerWidth < 400) {
        document.querySelectorAll('button').forEach(btn => {
          btn.style.fontSize = '14px';
          btn.style.padding = '12px 8px';
        });
        
        document.querySelectorAll('input, select').forEach(input => {
          input.style.fontSize = '14px';
          input.style.padding = '10px';
        });
      }
    }

    // =============== FUNGSI KAMERA & SCANNER ===============
    // Fungsi untuk mendapatkan daftar kamera
    async function getCameras() {
      try {
        const devices = await Html5Qrcode.getCameras();
        availableCameras = devices;
        
        const cameraSelect = document.getElementById('cameraSelect');
        cameraSelect.innerHTML = '';
        
        if (devices.length === 0) {
          cameraSelect.innerHTML = '<option value="">Tidak ada kamera ditemukan</option>';
          return;
        }
        
        // Tambahkan opsi untuk setiap kamera
        devices.forEach((device, index) => {
          const option = document.createElement('option');
          option.value = device.id;
          option.text = device.label || `Kamera ${index + 1}`;
          cameraSelect.appendChild(option);
        });
        
        // Pilih kamera belakang jika ada
        const backCamera = devices.find(device => 
          device.label.toLowerCase().includes('back') || 
          device.label.toLowerCase().includes('rear')
        );
        
        if (backCamera) {
          selectedCameraId = backCamera.id;
          cameraSelect.value = backCamera.id;
        } else if (devices.length > 0) {
          selectedCameraId = devices[0].id;
          cameraSelect.value = devices[0].id;
        }
        
        // Tampilkan selector kamera
        document.getElementById('cameraSelector').style.display = 'block';
        
      } catch (error) {
        console.error("Error getting cameras:", error);
        document.getElementById('cameraSelector').style.display = 'none';
      }
    }

    // Fungsi untuk memulai scanner
    async function startScanner() {
      if (isCameraActive) {
        alert("Kamera sudah aktif!");
        return;
      }
      
      const cameraStatus = document.getElementById("cameraStatus");
      const scannerButton = document.getElementById("scannerButton");
      const stopScannerButton = document.getElementById("stopScannerButton");
      const readerDiv = document.getElementById("reader");
      const cameraSelect = document.getElementById('cameraSelect');
      
      try {
        // Update UI
        scannerButton.textContent = "üîÑ Memulai Kamera...";
        scannerButton.disabled = true;
        cameraStatus.textContent = "üîÑ Memulai kamera...";
        cameraStatus.className = "camera-status";
        
        // Dapatkan ID kamera yang dipilih
        const cameraId = cameraSelect.value || selectedCameraId;
        
        if (!cameraId) {
          throw new Error("Tidak ada kamera yang dipilih");
        }
        
        // Inisialisasi scanner
        scanner = new Html5Qrcode("reader");
        
        // Konfigurasi scanner
        const config = {
          fps: 10,
          qrbox: { 
            width: 250, 
            height: 150,
            widthFromDevice: true
          },
          aspectRatio: 1.0,
          disableFlip: false
        };
        
        // Fungsi callback saat scan berhasil
        const qrCodeSuccessCallback = (decodedText, decodedResult) => {
          console.log("Scan berhasil:", decodedText);
          
          // Tampilkan efek sukses
          showScanSuccess();
          
          // Set nilai barcode
          document.getElementById("barcodeInput").value = decodedText;
          
          // Auto-fill nama barang jika ada di database
          handleBarcodeInput();
          
          // Fokus ke input qty
          setTimeout(() => {
            document.getElementById("qtyInput").focus();
            document.getElementById("qtyInput").select();
          }, 300);
          
          // Berhenti scanner sementara (opsional)
          // scanner.pause();
          
          // Lanjutkan scanning setelah 2 detik
          setTimeout(() => {
            if (scanner && isCameraActive) {
              // scanner.resume();
            }
          }, 2000);
        };
        
        // Fungsi callback untuk error
        const qrCodeErrorCallback = (error) => {
          // Abaikan error umum, hanya log untuk debugging
          if (!error.includes("NotFoundException")) {
            console.log("Scanner error:", error);
          }
        };
        
        // Mulai scanner
        await scanner.start(
          cameraId,
          config,
          qrCodeSuccessCallback,
          qrCodeErrorCallback
        );
        
        // Update status
        isCameraActive = true;
        scannerButton.textContent = "üì∑ Kamera Aktif";
        scannerButton.disabled = false;
        scannerButton.style.display = 'none';
        stopScannerButton.style.display = 'block';
        cameraStatus.textContent = "üì∏ Kamera aktif - Arahkan ke barcode";
        cameraStatus.className = "camera-status active";
        readerDiv.style.display = "block";
        
        // Tambahkan overlay visual
        addScannerOverlay();
        
        // Scroll ke area scanner
        readerDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
        
        console.log("Scanner started successfully");
        
      } catch (error) {
        console.error("Error starting scanner:", error);
        
        // Tampilkan pesan error yang lebih user-friendly
        let errorMessage = "Gagal mengaktifkan kamera: ";
        
        if (error.name === 'NotAllowedError') {
          errorMessage += "Izin kamera ditolak. Silakan izinkan akses kamera di pengaturan browser.";
        } else if (error.name === 'NotFoundError') {
          errorMessage += "Kamera tidak ditemukan. Pastikan perangkat memiliki kamera.";
        } else if (error.name === 'NotSupportedError') {
          errorMessage += "Browser tidak mendukung akses kamera.";
        } else if (error.name === 'NotReadableError') {
          errorMessage += "Kamera sedang digunakan oleh aplikasi lain.";
        } else {
          errorMessage += error.message;
        }
        
        alert("‚ùå " + errorMessage);
        
        // Reset UI
        scannerButton.textContent = "üì∑ Aktifkan Kamera Scanner";
        scannerButton.disabled = false;
        cameraStatus.textContent = "üìµ Gagal mengaktifkan kamera";
        cameraStatus.className = "camera-status inactive";
        
        // Reset scanner
        scanner = null;
        isCameraActive = false;
      }
    }

    // Fungsi untuk menghentikan scanner
    async function stopScanner() {
      if (!scanner || !isCameraActive) {
        return;
      }
      
      const scannerButton = document.getElementById("scannerButton");
      const stopScannerButton = document.getElementById("stopScannerButton");
      const cameraStatus = document.getElementById("cameraStatus");
      const readerDiv = document.getElementById("reader");
      
      try {
        // Update UI
        stopScannerButton.textContent = "üîÑ Mematikan...";
        stopScannerButton.disabled = true;
        
        // Hentikan scanner
        await scanner.stop();
        
        // Reset state
        scanner = null;
        isCameraActive = false;
        
        // Update UI
        scannerButton.textContent = "üì∑ Aktifkan Kamera Scanner";
        scannerButton.disabled = false;
        scannerButton.style.display = 'block';
        stopScannerButton.style.display = 'none';
        cameraStatus.textContent = "üìµ Kamera tidak aktif";
        cameraStatus.className = "camera-status inactive";
        readerDiv.style.display = "none";
        readerDiv.innerHTML = ''; // Clear reader content
        
        // Hapus overlay
        removeScannerOverlay();
        
        console.log("Scanner stopped successfully");
        
      } catch (error) {
        console.error("Error stopping scanner:", error);
        
        // Force reset
        scanner = null;
        isCameraActive = false;
        
        // Update UI
        scannerButton.textContent = "üì∑ Aktifkan Kamera Scanner";
        scannerButton.disabled = false;
        scannerButton.style.display = 'block';
        stopScannerButton.style.display = 'none';
        cameraStatus.textContent = "üìµ Kamera dimatikan paksa";
        cameraStatus.className = "camera-status inactive";
        readerDiv.style.display = "none";
        readerDiv.innerHTML = '';
        
        alert("‚ùå Gagal mematikan kamera dengan benar. Silakan refresh halaman jika bermasalah.");
      }
    }

    // Fungsi untuk menambahkan overlay scanner
    function addScannerOverlay() {
      const readerDiv = document.getElementById("reader");
      
      // Hapus overlay lama jika ada
      removeScannerOverlay();
      
      // Buat overlay baru
      const overlay = document.createElement('div');
      overlay.className = 'camera-overlay';
      overlay.id = 'scannerOverlay';
      
      // Buat area scan
      const scanRegion = document.createElement('div');
      scanRegion.className = 'scan-region';
      
      // Buat garis scan animasi
      const scanLine = document.createElement('div');
      scanLine.className = 'scan-line';
      
      // Tambahkan ke overlay
      scanRegion.appendChild(scanLine);
      overlay.appendChild(scanRegion);
      
      // Tambahkan instruksi
      const instructions = document.createElement('div');
      instructions.style.position = 'absolute';
      instructions.style.bottom = '20px';
      instructions.style.left = '0';
      instructions.style.width = '100%';
      instructions.style.textAlign = 'center';
      instructions.style.color = 'white';
      instructions.style.fontSize = '14px';
      instructions.style.fontWeight = 'bold';
      instructions.style.textShadow = '0 1px 3px rgba(0,0,0,0.8)';
      instructions.textContent = 'Arahkan barcode ke area kotak hijau';
      overlay.appendChild(instructions);
      
      // Tambahkan ke reader
      readerDiv.appendChild(overlay);
    }

    // Fungsi untuk menghapus overlay scanner
    function removeScannerOverlay() {
      const overlay = document.getElementById('scannerOverlay');
      if (overlay) {
        overlay.remove();
      }
    }

    // Fungsi untuk menampilkan efek scan sukses
    function showScanSuccess() {
      // Tampilkan flash effect
      const flash = document.getElementById('flashEffect');
      flash.style.display = 'block';
      setTimeout(() => {
        flash.style.display = 'none';
      }, 500);
      
      // Tampilkan success message
      const successMsg = document.getElementById('scanSuccess');
      successMsg.style.display = 'block';
      
      // Mainkan sukses (opsional - bisa ditambahkan sound)
      playBeepSound();
      
      // Sembunyikan setelah 2 detik
      setTimeout(() => {
        successMsg.style.display = 'none';
      }, 2000);
    }

    // Fungsi untuk memainkan suara beep (opsional)
    function playBeepSound() {
      try {
        // Coba buat audio context
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.value = 800;
        oscillator.type = 'sine';
        
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.5);
        
      } catch (error) {
        console.log("Tidak dapat memainkan suara:", error);
      }
    }

    // Fungsi untuk menambahkan barcode manual
    function addBarcodeManual() {
      const manualInput = document.getElementById("manualBarcodeInput");
      const barcode = manualInput.value.trim();
      
      if (!barcode) {
        alert("Masukkan barcode terlebih dahulu!");
        return;
      }
      
      document.getElementById("barcodeInput").value = barcode;
      handleBarcodeInput();
      manualInput.value = "";
      
      // Tampilkan feedback
      showScanSuccess();
      
      // Fokus ke qty input
      setTimeout(() => {
        document.getElementById("qtyInput").focus();
        document.getElementById("qtyInput").select();
      }, 300);
    }

    // Fungsi untuk toggle scanner dengan UI yang lebih baik
    function toggleScannerUI() {
      if (isCameraActive) {
        stopScanner();
      } else {
        // Cek apakah ada kamera yang tersedia
        if (availableCameras.length === 0) {
          alert("üîÑ Mencari kamera...");
          getCameras().then(() => {
            if (availableCameras.length > 0) {
              startScanner();
            } else {
              alert("‚ùå Tidak ada kamera yang ditemukan. Pastikan perangkat memiliki kamera dan izin sudah diberikan.");
            }
          });
        } else {
          startScanner();
        }
      }
    }

    // =============== FUNGSI TABEL ===============
    function updateTable() {
      const tbody = document.querySelector("#dataTable tbody");
      if (!tbody) return;
      
      tbody.innerHTML = "";

      dataScan.forEach((item, index) => {
        const row = tbody.insertRow();
        row.insertCell().innerText = item.user || "Unknown";
        row.insertCell().innerText = item.lokasi;
        row.insertCell().innerText = item.barcode;
        row.insertCell().innerText = item.nama;
        row.insertCell().innerText = item.qty;

        const aksiCell = row.insertCell();
        aksiCell.className = 'action-buttons';
        
        const editBtn = document.createElement("button");
        editBtn.textContent = "Edit";
        editBtn.style.backgroundColor = "#2196F3";
        editBtn.style.color = "white";
        editBtn.style.padding = "6px 8px";
        editBtn.style.fontSize = "13px";
        editBtn.onclick = () => {
          const newQty = prompt("Masukkan Qty baru:", item.qty);
          if (newQty !== null && !isNaN(newQty)) {
            item.qty = parseInt(newQty);
            saveDataToLocalStorage();
            updateTable();
          }
        };
        aksiCell.appendChild(editBtn);

        const delBtn = document.createElement("button");
        delBtn.textContent = "Hapus";
        delBtn.style.backgroundColor = "#f44336";
        delBtn.style.color = "white";
        delBtn.style.padding = "6px 8px";
        delBtn.style.fontSize = "13px";
        delBtn.onclick = () => {
          if (confirm("Yakin ingin menghapus baris ini?")) {
            dataScan.splice(index, 1);
            saveDataToLocalStorage();
            updateTable();
          }
        };
        aksiCell.appendChild(delBtn);
      });
    }

    function updateUploadedItemsTable() {
      const tbody = document.getElementById("uploadedItemsBody");
      if (!tbody) return;
      
      tbody.innerHTML = "";

      uploadedItems.forEach((item, index) => {
        const row = tbody.insertRow();
        row.insertCell().innerText = item.barcode;
        row.insertCell().innerText = item.nama;
        
        const qtyCell = row.insertCell();
        const qtyInput = document.createElement("input");
        qtyInput.type = "number";
        qtyInput.value = item.qty;
        qtyInput.style.width = "70px";
        qtyInput.style.padding = "6px";
        qtyInput.style.fontSize = "14px";
        qtyInput.min = "0";
        qtyInput.onchange = (e) => {
          uploadedItems[index].qty = parseInt(e.target.value) || 0;
          saveDataToLocalStorage();
        };
        qtyCell.appendChild(qtyInput);

        const actionCell = row.insertCell();
        actionCell.className = 'action-buttons';
        const deleteBtn = document.createElement("button");
        deleteBtn.textContent = "Hapus";
        deleteBtn.style.backgroundColor = "#f44336";
        deleteBtn.style.color = "white";
        deleteBtn.style.padding = "6px 8px";
        deleteBtn.style.fontSize = "13px";
        deleteBtn.onclick = () => {
          if (confirm("Yakin ingin menghapus item ini?")) {
            uploadedItems.splice(index, 1);
            updateUploadedItemsTable();
            saveDataToLocalStorage();
          }
        };
        actionCell.appendChild(deleteBtn);
      });
    }

    function saveDataToLocalStorage() {
      try {
        localStorage.setItem("dataScan", JSON.stringify(dataScan || []));
        localStorage.setItem("uploadedItems", JSON.stringify(uploadedItems || []));
      } catch (error) {
        console.error("Error saving to localStorage:", error);
      }
    }

    // =============== FUNGSI SUPABASE ===============
    function initSupabaseClient(url, key) {
      try {
        if (!url.startsWith('https://') || !url.includes('.supabase.co')) {
          throw new Error('URL Supabase tidak valid.');
        }
        
        if (key.length < 10) {
          throw new Error('API Key tidak valid');
        }
        
        supabaseClient = window.supabase.createClient(url, key);
        console.log("Supabase initialized successfully");
        return true;
      } catch (error) {
        console.error("Error initializing Supabase:", error);
        return false;
      }
    }

    async function testSupabaseConnection() {
      if (!supabaseClient) return false;
      
      try {
        const { data, error } = await supabaseClient
          .from('stok_barang')
          .select('count', { count: 'exact', head: true })
          .limit(1);
        
        if (error) {
          console.error("Supabase connection test failed:", error);
          return false;
        }
        
        return true;
      } catch (error) {
        console.error("Supabase connection test failed:", error);
        return false;
      }
    }

    async function updateSupabaseStatus() {
      const statusDiv = document.getElementById('supabaseStatus');
      const statusText = document.getElementById('supabaseStatusText');
      
      if (!statusDiv || !statusText) return;
      
      const supabaseUrl = localStorage.getItem("supabaseUrl");
      const supabaseKey = localStorage.getItem("supabaseKey");
      
      if (!supabaseUrl || !supabaseKey) {
        statusDiv.style.display = 'block';
        statusDiv.className = 'status-warning';
        statusText.innerHTML = '‚ö†Ô∏è SUPABASE BELUM DIKONFIGURASI';
        return;
      }
      
      if (!supabaseClient) {
        statusDiv.style.display = 'block';
        statusDiv.className = 'status-error';
        statusText.innerHTML = '‚ùå KONEKSI SUPABASE GAGAL';
        return;
      }
      
      const isConnected = await testSupabaseConnection();
      
      statusDiv.style.display = 'block';
      if (isConnected) {
        statusDiv.className = 'status-success';
        statusText.innerHTML = '‚úÖ TERHUBUNG KE SUPABASE (tabel: stok_barang)';
      } else {
        statusDiv.className = 'status-error';
        statusText.innerHTML = '‚ùå GAGAL TERHUBUNG KE SUPABASE';
      }
    }

    function showSupabaseConfig() {
      document.getElementById('supabaseUrl').value = localStorage.getItem("supabaseUrl") || "";
      document.getElementById('supabaseKey').value = localStorage.getItem("supabaseKey") || "";
      document.getElementById('supabaseModal').style.display = 'block';
    }

    function saveSupabaseConfig() {
      const url = document.getElementById('supabaseUrl').value.trim();
      const key = document.getElementById('supabaseKey').value.trim();
      
      if (!url || !key) {
        alert("URL dan API Key Supabase harus diisi.");
        return;
      }
      
      if (!url.startsWith('https://') || !url.includes('.supabase.co')) {
        alert("URL Supabase harus dalam format: https://your-project.supabase.co");
        return;
      }
      
      localStorage.setItem("supabaseUrl", url);
      localStorage.setItem("supabaseKey", key);
      
      if (initSupabaseClient(url, key)) {
        alert("‚úÖ Konfigurasi Supabase berhasil disimpan.");
        updateSupabaseStatus();
        document.getElementById('supabaseModal').style.display = 'none';
      }
    }

    function showSupabaseTableCreationGuide() {
      const sql = `-- Buat tabel stok_barang di Supabase
CREATE TABLE IF NOT EXISTS public.stok_barang (
  id BIGSERIAL PRIMARY KEY,
  user TEXT,
  lokasi TEXT,
  barcode TEXT,
  nama_barang TEXT,
  qty BIGINT DEFAULT 0,
  scanned_at TIMESTAMPTZ DEFAULT NOW(),
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Berikan izin akses
ALTER TABLE public.stok_barang ENABLE ROW LEVEL SECURITY;

-- Buat policy untuk akses
CREATE POLICY "Enable all access for authenticated users" 
ON public.stok_barang 
FOR ALL 
TO authenticated 
USING (true) 
WITH CHECK (true);`;
      
      alert(`UNTUK MEMBUAT TABEL DI SUPABASE:\n\n1. Buka Supabase Dashboard\n2. Pilih SQL Editor\n3. Jalankan query berikut:\n\n${sql}`);
    }

    // =============== FUNGSI AMBIL DATA PER LOKASI ===============
    async function showLocationDataModal() {
      if (!supabaseClient) {
        alert("Silakan konfigurasi Supabase terlebih dahulu.");
        showSupabaseConfig();
        return;
      }
      
      if (isFetchingData) {
        alert("Sedang mengambil data, harap tunggu...");
        return;
      }
      
      document.getElementById('locationModal').style.display = 'block';
      await loadAllDataFromSupabase();
    }

    async function loadAllDataFromSupabase() {
      if (isFetchingData) return;
      
      try {
        isFetchingData = true;
        const locationList = document.getElementById('locationList');
        const progressBarContainer = document.getElementById('progressBarContainer');
        const progressBar = document.getElementById('progressBar');
        const loadingStatus = document.getElementById('loadingStatus');
        const loadingDetails = document.getElementById('loadingDetails');
        
        if (!locationList) return;
        
        locationList.innerHTML = '<div style="text-align: center; padding: 30px; color: #666; font-size: 16px;">üîÑ Memuat data dari Supabase...</div>';
        progressBarContainer.style.display = 'block';
        progressBar.style.width = '5%';
        progressBar.textContent = '5%';
        loadingStatus.style.display = 'block';
        loadingDetails.textContent = 'Menyiapkan...';
        
        console.log('Memulai pengambilan data dari Supabase...');
        
        // Ambil total count terlebih dahulu
        loadingDetails.textContent = 'Menghitung total data...';
        progressBar.style.width = '10%';
        progressBar.textContent = '10%';
        
        const { count, error: countError } = await supabaseClient
          .from('stok_barang')
          .select('*', { count: 'exact', head: true });
        
        if (countError) {
          throw countError;
        }
        
        const totalData = count || 0;
        console.log(`Total data di Supabase: ${totalData}`);
        loadingDetails.textContent = `Total data: ${totalData.toLocaleString()} item`;
        progressBar.style.width = '20%';
        progressBar.textContent = '20%';
        
        if (totalData === 0) {
          locationList.innerHTML = '<div style="text-align: center; padding: 30px; color: #666; font-size: 16px;">üì≠ Tidak ada data ditemukan di Supabase.</div>';
          progressBarContainer.style.display = 'none';
          loadingStatus.style.display = 'none';
          isFetchingData = false;
          return;
        }
        
        // Ambil data dengan pagination
        const pageSize = 1000;
        const totalPages = Math.ceil(totalData / pageSize);
        let allData = [];
        
        for (let page = 0; page < totalPages; page++) {
          const from = page * pageSize;
          const to = from + pageSize - 1;
          
          loadingDetails.textContent = `Mengambil data ${from + 1}-${Math.min(to + 1, totalData)} dari ${totalData}...`;
          const progressPercent = Math.min(20 + ((page + 1) / totalPages * 70), 90);
          progressBar.style.width = `${progressPercent}%`;
          progressBar.textContent = `${Math.round(progressPercent)}%`;
          
          console.log(`Mengambil halaman ${page + 1}/${totalPages}...`);
          
          const { data, error } = await supabaseClient
            .from('stok_barang')
            .select('*')
            .range(from, to)
            .order('lokasi', { ascending: true });
          
          if (error) {
            throw error;
          }
          
          if (data && data.length > 0) {
            allData = allData.concat(data);
            console.log(`Halaman ${page + 1}: ${data.length} data, total: ${allData.length} data`);
          }
          
          // Beri jeda untuk UI tidak freeze
          await new Promise(resolve => setTimeout(resolve, 50));
        }
        
        console.log(`Total data berhasil diambil: ${allData.length} baris`);
        
        if (allData.length === 0) {
          locationList.innerHTML = '<div style="text-align: center; padding: 30px; color: #666; font-size: 16px;">üì≠ Tidak ada data ditemukan di Supabase.</div>';
          progressBarContainer.style.display = 'none';
          loadingStatus.style.display = 'none';
          isFetchingData = false;
          return;
        }
        
        // Kelompokkan data berdasarkan lokasi
        loadingDetails.textContent = 'Mengelompokkan data berdasarkan lokasi...';
        progressBar.style.width = '95%';
        progressBar.textContent = '95%';
        
        const groupedData = {};
        allData.forEach(item => {
          const location = item.lokasi || 'Tidak Ada Lokasi';
          if (!groupedData[location]) {
            groupedData[location] = [];
          }
          groupedData[location].push(item);
        });
        
        console.log(`Jumlah lokasi: ${Object.keys(groupedData).length}`);
        
        // Tampilkan tombol lokasi dengan ukuran lebih besar
        locationList.innerHTML = '';
        const locations = Object.keys(groupedData).sort();
        
        // Tambahkan tombol "Semua Lokasi"
        const allButton = document.createElement('button');
        allButton.className = 'user-button';
        allButton.dataset.location = 'Semua Lokasi';
        allButton.style.fontSize = '15px';
        allButton.style.padding = '18px 10px';
        allButton.innerHTML = `
          <div style="font-weight: bold; margin-bottom: 5px;">üì¶ SEMUA LOKASI</div>
          <div style="font-size: 13px; background: #666; color: white; padding: 4px 8px; border-radius: 12px; display: inline-block;">
            ${allData.length.toLocaleString()} ITEM
          </div>
        `;
        allButton.onclick = (e) => {
          selectLocationInModal('Semua Lokasi', allData, e.target);
        };
        locationList.appendChild(allButton);
        
        // Tambahkan tombol untuk setiap lokasi dengan ukuran lebih besar
        locations.forEach(location => {
          if (groupedData[location].length > 0) {
            const button = document.createElement('button');
            button.className = 'user-button';
            button.dataset.location = location;
            button.style.fontSize = '15px';
            button.style.padding = '18px 10px';
            
            // Potong teks lokasi jika terlalu panjang
            const displayLocation = location.length > 20 ? location.substring(0, 20) + '...' : location;
            
            button.innerHTML = `
              <div style="font-weight: bold; margin-bottom: 5px;">üìç ${displayLocation}</div>
              <div style="font-size: 13px; background: #666; color: white; padding: 4px 8px; border-radius: 12px; display: inline-block;">
                ${groupedData[location].length.toLocaleString()} ITEM
              </div>
            `;
            button.onclick = (e) => {
              selectLocationInModal(location, groupedData[location], e.target);
            };
            locationList.appendChild(button);
          }
        });
        
        // Setup filter
        const filterInput = document.getElementById('filterLocation');
        if (filterInput) {
          filterInput.oninput = function() {
            const searchTerm = this.value.toLowerCase();
            const buttons = locationList.querySelectorAll('.user-button');
            buttons.forEach(button => {
              const locationName = button.dataset.location.toLowerCase();
              button.style.display = locationName.includes(searchTerm) ? 'block' : 'none';
            });
          };
        }
        
        // Selesaikan progress bar
        progressBar.style.width = '100%';
        progressBar.textContent = '100%';
        
        // Sembunyikan progress bar setelah 1 detik
        setTimeout(() => {
          progressBarContainer.style.display = 'none';
          loadingStatus.style.display = 'none';
        }, 1000);
        
        // Tampilkan statistik
        const statsDiv = document.createElement('div');
        statsDiv.style.marginTop = '15px';
        statsDiv.style.padding = '15px';
        statsDiv.style.background = '#e8f5e8';
        statsDiv.style.borderRadius = '10px';
        statsDiv.style.fontSize = '14px';
        statsDiv.style.borderLeft = '5px solid #4CAF50';
        statsDiv.innerHTML = `
          <div style="font-weight: bold; color: #155724; margin-bottom: 8px; font-size: 15px;">‚úÖ DATA BERHASIL DIMUAT</div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <div>
              <div style="font-weight: bold;">üìä Total Data:</div>
              <div style="color: #388e3c;">${allData.length.toLocaleString()} item</div>
            </div>
            <div>
              <div style="font-weight: bold;">üìç Lokasi:</div>
              <div style="color: #388e3c;">${locations.length} lokasi</div>
            </div>
          </div>
        `;
        locationList.parentNode.insertBefore(statsDiv, locationList.nextSibling);
        
      } catch (error) {
        console.error('Error loading data:', error);
        const locationList = document.getElementById('locationList');
        if (locationList) {
          locationList.innerHTML = `
            <div style="text-align: center; padding: 30px; color: #dc2626;">
              <div style="font-size: 18px; font-weight: bold; margin-bottom: 10px;">‚ùå GAGAL MEMUAT DATA</div>
              <div style="font-size: 14px; color: #666; margin-bottom: 15px;">${error.message}</div>
              <button onclick="showSupabaseTableCreationGuide()" style="padding: 12px 20px; background: #4CAF50; color: white; border: none; border-radius: 8px; font-size: 15px; font-weight: bold;">
                üìã LIHAT PANDUAN BUAT TABEL
              </button>
            </div>
          `;
        }
        
        const progressBarContainer = document.getElementById('progressBarContainer');
        const loadingStatus = document.getElementById('loadingStatus');
        if (progressBarContainer) progressBarContainer.style.display = 'none';
        if (loadingStatus) loadingStatus.style.display = 'none';
      } finally {
        isFetchingData = false;
      }
    }

    function selectLocationInModal(location, items, target) {
      // Update UI
      const buttons = document.querySelectorAll('#locationList .user-button');
      buttons.forEach(btn => btn.classList.remove('active'));
      target.classList.add('active');
      
      // Tampilkan info lokasi
      const infoDiv = document.getElementById('locationDataInfo');
      const infoContent = document.getElementById('selectedLocationInfo');
      const countDiv = document.getElementById('locationItemCount');
      const loadBtn = document.getElementById('loadLocationDataBtn');
      
      if (infoDiv && infoContent && countDiv && loadBtn) {
        infoDiv.style.display = 'block';
        infoContent.innerHTML = `<div style="font-size: 17px;">üìç ${location}</div>`;
        countDiv.innerHTML = `<div style="font-size: 15px; margin-top: 5px;">üì¶ ${items.length.toLocaleString()} item ditemukan</div>`;
        loadBtn.style.display = 'block';
        
        // Simpan data lokasi yang dipilih
        loadBtn.dataset.location = location;
        loadBtn.dataset.items = JSON.stringify(items);
      }
    }

    function loadSelectedLocationData() {
      const loadBtn = document.getElementById('loadLocationDataBtn');
      if (!loadBtn || !loadBtn.dataset.location) {
        alert('Pilih lokasi terlebih dahulu.');
        return;
      }
      
      const location = loadBtn.dataset.location;
      const items = JSON.parse(loadBtn.dataset.items);
      
      // Tutup modal lokasi
      document.getElementById('locationModal').style.display = 'none';
      
      // Tampilkan modal isi qty
      showQtyModal(location, items);
    }

    function showQtyModal(location, items) {
      const modal = document.getElementById('qtyModal');
      const locationNameSpan = document.getElementById('modalLocationName');
      const currentLocationInfo = document.getElementById('currentLocationInfo');
      const itemsBody = document.getElementById('locationItemsBody');
      
      if (!modal || !locationNameSpan || !currentLocationInfo || !itemsBody) return;
      
      // Set data lokasi
      locationNameSpan.textContent = location;
      currentLocationInfo.innerHTML = `
        <div>
          <div style="font-size: 17px; font-weight: bold;">üìç ${location}</div>
          <div style="font-size: 15px; color: #666; margin-top: 5px;">üì¶ ${items.length.toLocaleString()} item</div>
        </div>
      `;
      
      // Isi tabel items dengan ukuran font lebih besar
      itemsBody.innerHTML = '';
      
      const displayItems = items.slice(0, 100); // Batasi untuk performa mobile
      
      if (displayItems.length === 0) {
        itemsBody.innerHTML = `
          <tr>
            <td colspan="4" style="text-align: center; padding: 30px; color: #666; font-size: 16px;">
              üì≠ Tidak ada item di lokasi ini
            </td>
          </tr>
        `;
      } else {
        if (items.length > 100) {
          const warningRow = document.createElement('tr');
          warningRow.innerHTML = `
            <td colspan="4" style="text-align: center; padding: 15px; background: #fff3cd; color: #856404; font-size: 14px;">
              <strong>‚ÑπÔ∏è INFO:</strong> Menampilkan 100 item pertama dari ${items.length.toLocaleString()} item total
            </td>
          `;
          itemsBody.appendChild(warningRow);
        }
        
        displayItems.forEach((item, index) => {
          const row = document.createElement('tr');
          row.style.borderBottom = '2px solid #f0f0f0';
          
          // Gunakan field yang benar dari database
          const namaBarang = item.nama_barang || item.nama || item.item_name || 'N/A';
          const barcodeBarang = item.barcode || item.kode || item.kode_barang || '-';
          const qtyBarang = item.qty || item.quantity || item.stock || 0;
          
          // Potong nama jika terlalu panjang untuk mobile
          const displayNama = namaBarang.length > 30 ? namaBarang.substring(0, 30) + '...' : namaBarang;
          
          row.innerHTML = `
            <td style="padding: 15px 10px; text-align: center; vertical-align: middle;">
              <input type="checkbox" class="item-checkbox" data-index="${index}" style="width: 22px; height: 22px;" />
            </td>
            <td style="padding: 15px 10px; vertical-align: middle;">
              <div style="font-weight: bold; font-size: 15px; margin-bottom: 3px;">${displayNama}</div>
              ${qtyBarang ? `<div style="font-size: 13px; color: #4CAF50; background: #e8f5e8; padding: 3px 8px; border-radius: 4px; display: inline-block;">Stok: ${qtyBarang}</div>` : ''}
            </td>
            <td style="padding: 15px 10px; font-family: monospace; font-size: 14px; vertical-align: middle;">
              ${barcodeBarang}
            </td>
            <td style="padding: 15px 10px; vertical-align: middle;">
              <input type="number" 
                     class="item-qty" 
                     data-index="${index}"
                     min="0" 
                     value="0" 
                     style="width: 80px; padding: 10px; text-align: center; font-size: 15px; border: 2px solid #ddd; border-radius: 6px;"
                     placeholder="0" />
            </td>
          `;
          
          itemsBody.appendChild(row);
        });
      }
      
      // Update selected count
      updateSelectedCount();
      
      // Tampilkan modal
      modal.style.display = 'block';
      
      // Adjust UI setelah modal terbuka
      setTimeout(adjustForMobile, 100);
    }

    function updateSelectedCount() {
      const checkboxes = document.querySelectorAll('.item-checkbox:checked');
      const countDiv = document.getElementById('selectedCount');
      
      if (countDiv) {
        const count = checkboxes.length;
        countDiv.innerHTML = `
          <div style="font-size: 16px; color: #333;">
            <span style="font-weight: bold; color: #4CAF50;">${count}</span> ITEM DIPILIH
          </div>
        `;
      }
    }

    function selectAllItems() {
      const selectAllCheckbox = document.getElementById('selectAllCheckbox');
      const itemCheckboxes = document.querySelectorAll('.item-checkbox');
      
      if (!selectAllCheckbox) return;
      
      const isChecked = selectAllCheckbox.checked;
      itemCheckboxes.forEach(checkbox => {
        checkbox.checked = isChecked;
      });
      
      updateSelectedCount();
    }

    function saveQtyToDataScan() {
      const locationName = document.getElementById('modalLocationName').textContent;
      const user = document.getElementById("userInput").value || "Unknown";
      
      // Ambil semua baris dari tabel
      const rows = document.querySelectorAll('#locationItemsBody tr');
      const selectedItems = [];
      
      rows.forEach((row, index) => {
        const checkbox = row.querySelector('.item-checkbox');
        const qtyInput = row.querySelector('.item-qty');
        
        // Periksa apakah checkbox dicentang
        if (checkbox && checkbox.checked) {
          const qty = parseInt(qtyInput.value) || 0;
          if (qty > 0) {
            // Ambil data dari baris
            const cells = row.querySelectorAll('td');
            
            // Cell 1: checkbox, Cell 2: nama, Cell 3: barcode, Cell 4: qty input
            const namaCell = cells[1];
            const barcodeCell = cells[2];
            
            // Ambil teks dari sel, hapus informasi tambahan
            let namaText = namaCell.querySelector('div')?.textContent || namaCell.textContent;
            // Hapus "Stok: X" jika ada
            namaText = namaText.split('Stok:')[0].trim();
            
            const barcode = barcodeCell.textContent.trim();
            
            // Simpan data item yang dipilih
            selectedItems.push({
              barcode: barcode,
              nama: namaText,
              qty: qty,
              lokasi: locationName,
              user: user
            });
          }
        }
      });
      
      if (selectedItems.length === 0) {
        alert('‚ùå Pilih minimal satu item dan isi qty yang valid.');
        return;
      }
      
      // Simpan ke dataScan
      let count = 0;
      selectedItems.forEach(item => {
        const { barcode, nama, qty, lokasi, user } = item;
        
        if (barcode && barcode !== '-' && nama && nama !== 'N/A') {
          // Cek apakah item sudah ada di dataScan
          const existingIndex = dataScan.findIndex(scan => 
            scan.barcode === barcode && 
            scan.lokasi === lokasi && 
            scan.user === user
          );
          
          if (existingIndex > -1) {
            // Update qty jika sudah ada
            dataScan[existingIndex].qty += qty;
          } else {
            // Tambah data baru
            dataScan.push({
              user: user,
              lokasi: lokasi,
              barcode: barcode,
              nama: nama,
              qty: qty
            });
          }
          count++;
        }
      });
      
      // Update table dan simpan
      saveDataToLocalStorage();
      updateTable();
      
      // Tutup modal
      document.getElementById('qtyModal').style.display = 'none';
      
      alert(`‚úÖ ${count} item berhasil ditambahkan ke data scan untuk lokasi ${locationName}.`);
    }

    // =============== FUNGSI SIMPAN KE SUPABASE ===============
    async function saveToSupabase() {
      if (!supabaseClient) {
        alert("Silakan konfigurasi Supabase terlebih dahulu.");
        showSupabaseConfig();
        return;
      }
      
      if (dataScan.length === 0) {
        alert("Tidak ada data untuk disimpan!");
        return;
      }
      
      if (!confirm(`Simpan ${dataScan.length} data ke tabel stok_barang di Supabase?`)) {
        return;
      }
      
      // Tampilkan loading
      const originalText = document.getElementById('saveToSupabaseBtn').textContent;
      document.getElementById('saveToSupabaseBtn').textContent = 'üîÑ Menyimpan...';
      document.getElementById('saveToSupabaseBtn').disabled = true;
      
      try {
        // Siapkan data untuk disimpan - SESUAIKAN DENGAN KOLOM DI SUPABASE
        const dataToSave = dataScan.map(item => ({
          user: item.user || "Unknown",
          lokasi: item.lokasi || "Unknown",
          barcode: item.barcode || "",
          nama_barang: item.nama || "", // PERHATIAN: nama_barang (bukan 'nama')
          qty: item.qty || 0,
          scanned_at: new Date().toISOString(),
          created_at: new Date().toISOString()
        }));
        
        console.log("Menyimpan data ke tabel stok_barang:", dataToSave);
        
        // Kirim data ke Supabase
        const { data, error } = await supabaseClient
          .from('stok_barang')
          .insert(dataToSave);
        
        if (error) {
          throw error;
        }
        
        alert(`‚úÖ ${dataScan.length} data berhasil disimpan ke tabel stok_barang di Supabase!`);
        
        // Kosongkan data setelah disimpan
        dataScan = [];
        saveDataToLocalStorage();
        updateTable();
        updateSupabaseStatus();
        
      } catch (error) {
        console.error("Error saving to Supabase:", error);
        
        // Berikan pesan error yang lebih spesifik
        let errorMessage = error.message;
        if (error.message.includes('violates unique constraint')) {
          errorMessage = "Beberapa data sudah ada di database. Silakan hapus data duplikat terlebih dahulu.";
        } else if (error.message.includes('permission denied')) {
          errorMessage = "Izin ditolak. Pastikan API key memiliki hak akses INSERT ke tabel stok_barang.";
        } else if (error.message.includes('Could not find the table')) {
          errorMessage = "Tabel 'stok_barang' tidak ditemukan. Silakan buat tabel terlebih dahulu di Supabase.";
        } else if (error.message.includes('column "nama_barang" of relation "stok_barang" does not exist')) {
          errorMessage = "Kolom 'nama_barang' tidak ditemukan di tabel. Pastikan struktur tabel sesuai.";
        }
        
        alert(`‚ùå Gagal menyimpan ke Supabase: ${errorMessage}`);
        
        // Tampilkan opsi untuk membuat tabel
        if (error.message.includes('Could not find the table') || error.message.includes('column') || error.message.includes('does not exist')) {
          if (confirm("Struktur tabel tidak sesuai. Lihat panduan membuat tabel stok_barang?")) {
            showSupabaseTableCreationGuide();
          }
        }
        
      } finally {
        // Reset tombol
        document.getElementById('saveToSupabaseBtn').textContent = originalText;
        document.getElementById('saveToSupabaseBtn').disabled = false;
      }
    }

    // =============== FUNGSI LAINNYA ===============
    function lockLokasi() {
      const lokasiInput = document.getElementById("lokasiInput");
      if (lokasiInput.value.trim() === "") {
        alert("Harap isi nama lokasi terlebih dahulu!");
        return;
      }
      lokasiInput.disabled = true;
      lokasiTerkunci = true;
      alert("‚úÖ Lokasi berhasil dikunci!");
    }

    function ubahLokasi() {
      const lokasiInput = document.getElementById("lokasiInput");
      lokasiInput.disabled = false;
      lokasiTerkunci = false;
      lokasiInput.focus();
      alert("‚úÖ Lokasi bisa diubah, silakan edit.");
    }

    function lockUploadLokasi() {
      const lokasiInput = document.getElementById("uploadLokasiInput");
      if (lokasiInput.value.trim() === "") {
        alert("Harap isi nama lokasi terlebih dahulu!");
        return;
      }
      lokasiInput.disabled = true;
      uploadLokasiTerkunci = true;
      alert("‚úÖ Lokasi berhasil dikunci!");
    }

    function ubahUploadLokasi() {
      const lokasiInput = document.getElementById("uploadLokasiInput");
      lokasiInput.disabled = false;
      uploadLokasiTerkunci = false;
      lokasiInput.focus();
      alert("‚úÖ Lokasi bisa diubah, silakan edit.");
    }

    function handleBarcodeInput() {
      const barcodeInput = document.getElementById("barcodeInput");
      const namaBarangInput = document.getElementById("namaBarangInput");
      const barcode = barcodeInput.value.trim();
      
      if (barcode) {
        if (dataBarang[barcode]) {
          namaBarangInput.value = dataBarang[barcode];
          namaBarangInput.style.color = "#155724";
          namaBarangInput.style.backgroundColor = "#d4edda";
        } else {
          namaBarangInput.value = "‚ùå Barang tidak ditemukan";
          namaBarangInput.style.color = "#721c24";
          namaBarangInput.style.backgroundColor = "#f8d7da";
        }
      } else {
        namaBarangInput.value = "";
        namaBarangInput.style.color = "";
        namaBarangInput.style.backgroundColor = "#f5f5f5";
      }
    }

    function tambahData() {
      const user = document.getElementById("userInput").value || "Unknown";
      const lokasi = document.getElementById("lokasiInput").value;
      const barcode = document.getElementById("barcodeInput").value.trim();
      const nama = document.getElementById("namaBarangInput").value;
      const qty = parseInt(document.getElementById("qtyInput").value) || 0;
      
      if (!lokasi) {
        alert("‚ùå Harap isi nama lokasi terlebih dahulu!");
        return;
      }
      
      if (!barcode) {
        alert("‚ùå Harap scan atau masukkan barcode!");
        return;
      }
      
      if (!nama || nama === "‚ùå Barang tidak ditemukan") {
        alert("‚ùå Barang tidak ditemukan dalam database!");
        return;
      }
      
      if (qty <= 0) {
        alert("‚ùå Harap masukkan jumlah (qty) yang valid!");
        return;
      }
      
      // Cek apakah item sudah ada
      const existingIndex = dataScan.findIndex(item => 
        item.barcode === barcode && item.lokasi === lokasi && item.user === user
      );
      
      if (existingIndex > -1) {
        // Update qty jika sudah ada
        dataScan[existingIndex].qty += qty;
        alert(`‚úÖ Qty untuk ${nama} diperbarui menjadi ${dataScan[existingIndex].qty}`);
      } else {
        // Tambah data baru
        dataScan.push({
          user: user,
          lokasi: lokasi,
          barcode: barcode,
          nama: nama,
          qty: qty
        });
        alert(`‚úÖ Data ${nama} berhasil ditambahkan!`);
      }
      
      // Reset input
      document.getElementById("barcodeInput").value = "";
      document.getElementById("namaBarangInput").value = "";
      document.getElementById("namaBarangInput").style.color = "";
      document.getElementById("namaBarangInput").style.backgroundColor = "#f5f5f5";
      document.getElementById("qtyInput").value = "1";
      
      // Fokus kembali ke input barcode
      document.getElementById("barcodeInput").focus();
      
      // Update table dan simpan
      saveDataToLocalStorage();
      updateTable();
    }

    function handleFileUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
        const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
        
        // Reset dataBarang
        dataBarang = {};
        
        // Asumsi kolom: Barcode di kolom 0, Nama di kolom 1
        jsonData.forEach(row => {
          if (row[0] && row[1]) {
            dataBarang[row[0].toString()] = row[1].toString();
          }
        });
        
        alert(`‚úÖ Data barang berhasil diupload! ${Object.keys(dataBarang).length} item tersedia.`);
      };
      reader.readAsArrayBuffer(file);
    }

    function handleBulkFileUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const user = document.getElementById("uploadUserInput").value || "Unknown";
      const lokasi = document.getElementById("uploadLokasiInput").value;
      
      if (!lokasi) {
        alert("‚ùå Harap isi nama lokasi terlebih dahulu!");
        event.target.value = "";
        return;
      }
      
      const reader = new FileReader();
      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
        const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
        
        // Reset uploadedItems
        uploadedItems = [];
        
        // Asumsi kolom: Barcode di kolom 0, Nama di kolom 1, Qty di kolom 2
        jsonData.forEach((row, index) => {
          if (index === 0) return; // Skip header
          
          if (row[0] && row[1]) {
            uploadedItems.push({
              user: user,
              lokasi: lokasi,
              barcode: row[0].toString(),
              nama: row[1].toString(),
              qty: parseInt(row[2]) || 0
            });
          }
        });
        
        updateUploadedItemsTable();
        saveDataToLocalStorage();
        alert(`‚úÖ ${uploadedItems.length} item berhasil diupload!`);
      };
      reader.readAsArrayBuffer(file);
    }

    function saveUploadedData() {
      if (uploadedItems.length === 0) {
        alert("Tidak ada data untuk disimpan!");
        return;
      }
      
      // Tambahkan semua uploadedItems ke dataScan
      uploadedItems.forEach(item => {
        const existingIndex = dataScan.findIndex(scan => 
          scan.barcode === item.barcode && 
          scan.lokasi === item.lokasi && 
          scan.user === item.user
        );
        
        if (existingIndex > -1) {
          dataScan[existingIndex].qty += item.qty;
        } else {
          dataScan.push({...item});
        }
      });
      
      // Kosongkan uploadedItems
      uploadedItems = [];
      updateUploadedItemsTable();
      saveDataToLocalStorage();
      updateTable();
      
      alert(`‚úÖ Data berhasil ditambahkan ke data scan!`);
    }

    function clearUploadedData() {
      if (confirm("Yakin ingin menghapus semua data yang diupload?")) {
        uploadedItems = [];
        updateUploadedItemsTable();
        saveDataToLocalStorage();
      }
    }

    function exportToExcel() {
      if (dataScan.length === 0) {
        alert("Tidak ada data untuk diexport!");
        return;
      }
      
      const ws = XLSX.utils.json_to_sheet(dataScan);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Data Stok Opname");
      
      // Buat nama file dengan timestamp
      const date = new Date();
      const timestamp = `${date.getFullYear()}${(date.getMonth()+1).toString().padStart(2,'0')}${date.getDate().toString().padStart(2,'0')}_${date.getHours().toString().padStart(2,'0')}${date.getMinutes().toString().padStart(2,'0')}`;
      const filename = `stok_opname_${timestamp}.xlsx`;
      
      XLSX.writeFile(wb, filename);
    }

    function hapusSemuaData() {
      if (dataScan.length === 0 && uploadedItems.length === 0) {
        alert("Tidak ada data untuk dihapus!");
        return;
      }
      
      if (confirm("Yakin ingin menghapus SEMUA data scan dan data yang diupload?")) {
        dataScan = [];
        uploadedItems = [];
        saveDataToLocalStorage();
        updateTable();
        updateUploadedItemsTable();
        alert("‚úÖ Semua data berhasil dihapus!");
      }
    }

    // =============== SETUP EVENT LISTENERS ===============
    function setupEventListeners() {
      // Tab menu
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', function() {
          const tabId = this.dataset.tab;
          
          // Sembunyikan semua tab content
          document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
          });
          
          // Tampilkan tab yang dipilih
          const selectedTab = document.getElementById(tabId);
          if (selectedTab) {
            selectedTab.classList.add('active');
          }
          
          // Update tab menu
          document.querySelectorAll('.tab').forEach(tab => {
            tab.classList.remove('active');
          });
          this.classList.add('active');
          
          // Jika berpindah ke tab scan, matikan kamera jika aktif
          if (tabId === 'uploadTab' && isCameraActive) {
            stopScanner();
          }
        });
      });
      
      // Scan Tab - Scanner Controls
      document.getElementById('scannerButton')?.addEventListener('click', toggleScannerUI);
      document.getElementById('stopScannerButton')?.addEventListener('click', stopScanner);
      
      // Camera selector change
      document.getElementById('cameraSelect')?.addEventListener('change', function() {
        selectedCameraId = this.value;
        // Restart scanner if active
        if (isCameraActive) {
          stopScanner().then(() => {
            setTimeout(() => startScanner(), 500);
          });
        }
      });
      
      // Manual barcode input
      document.getElementById('manualAddBtn')?.addEventListener('click', addBarcodeManual);
      document.getElementById('manualBarcodeInput')?.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          addBarcodeManual();
        }
      });
      
      // Lokasi buttons
      document.getElementById('lockLokasiBtn')?.addEventListener('click', lockLokasi);
      document.getElementById('ubahLokasiBtn')?.addEventListener('click', ubahLokasi);
      
      // File upload
      document.getElementById('uploadFile')?.addEventListener('change', handleFileUpload);
      document.getElementById('uploadFileBtn')?.addEventListener('click', () => {
        document.getElementById('uploadFile').click();
      });
      
      // Barcode input handling
      document.getElementById('barcodeInput')?.addEventListener('input', handleBarcodeInput);
      document.getElementById('barcodeInput')?.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          tambahData();
        }
      });
      
      // Tambah data button
      document.getElementById('tambahDataBtn')?.addEventListener('click', tambahData);
      document.getElementById('qtyInput')?.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          tambahData();
        }
      });
      
      // Upload Tab
      document.getElementById('lockUploadLokasiBtn')?.addEventListener('click', lockUploadLokasi);
      document.getElementById('ubahUploadLokasiBtn')?.addEventListener('click', ubahUploadLokasi);
      document.getElementById('bulkUploadFile')?.addEventListener('change', handleBulkFileUpload);
      document.getElementById('bulkUploadBtn')?.addEventListener('click', () => {
        document.getElementById('bulkUploadFile').click();
      });
      document.getElementById('saveUploadedDataBtn')?.addEventListener('click', saveUploadedData);
      document.getElementById('clearUploadedDataBtn')?.addEventListener('click', clearUploadedData);
      
      // Main Buttons
      document.getElementById('exportDataBtn')?.addEventListener('click', exportToExcel);
      document.getElementById('showLocationDataBtn')?.addEventListener('click', showLocationDataModal);
      document.getElementById('saveToSupabaseBtn')?.addEventListener('click', saveToSupabase);
      document.getElementById('showSupabaseConfigBtn')?.addEventListener('click', showSupabaseConfig);
      document.getElementById('hapusSemuaDataBtn')?.addEventListener('click', hapusSemuaData);
      
      // Supabase Modal
      document.getElementById('saveSupabaseConfigBtn')?.addEventListener('click', saveSupabaseConfig);
      document.getElementById('cancelSupabaseConfigBtn')?.addEventListener('click', () => {
        document.getElementById('supabaseModal').style.display = 'none';
      });
      
      // Location Modal
      document.getElementById('loadLocationDataBtn')?.addEventListener('click', loadSelectedLocationData);
      document.getElementById('closeLocationModalBtn')?.addEventListener('click', () => {
        document.getElementById('locationModal').style.display = 'none';
      });
      
      // Qty Modal
      document.getElementById('closeQtyModalBtn')?.addEventListener('click', () => {
        document.getElementById('qtyModal').style.display = 'none';
      });
      document.getElementById('selectAllBtn')?.addEventListener('click', function() {
        const selectAllCheckbox = document.getElementById('selectAllCheckbox');
        if (selectAllCheckbox) {
          selectAllCheckbox.checked = !selectAllCheckbox.checked;
          selectAllItems();
        }
      });
      document.getElementById('selectAllCheckbox')?.addEventListener('change', selectAllItems);
      document.getElementById('saveQtyBtn')?.addEventListener('click', saveQtyToDataScan);
      
      // Event listener untuk checkbox di tabel qty
      document.addEventListener('change', function(e) {
        if (e.target.classList.contains('item-checkbox')) {
          updateSelectedCount();
        }
      });
      
      // Close modal when clicking outside
      window.addEventListener('click', function(e) {
        if (e.target.classList.contains('modal')) {
          e.target.style.display = 'none';
        }
      });
      
      // Adjust UI on resize
      window.addEventListener('resize', adjustForMobile);
      
      // Get available cameras on load
      setTimeout(() => {
        getCameras();
      }, 1000);
      
      // Handle page visibility change (pause scanner when tab not active)
      document.addEventListener('visibilitychange', function() {
        if (document.hidden && isCameraActive) {
          // Optional: pause scanner when tab is not active
          console.log("Tab tidak aktif, pertimbangkan untuk pause scanner");
        }
      });
      
      // Handle beforeunload (clean up scanner)
      window.addEventListener('beforeunload', function() {
        if (isCameraActive) {
          // Try to stop scanner
          if (scanner && scanner.stop) {
            scanner.stop().catch(console.error);
          }
        }
      });
    }

    // =============== START APPLICATION ===============
    document.addEventListener('DOMContentLoaded', initApp);
  </script>
</body>
</html>
